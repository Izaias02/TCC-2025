<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administração - G.L.I.N.P</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="d-flex flex-column min-vh-100">

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ----- VERIFICAÇÃO DE SESSÃO -----
  function verificarSessao(tipoUsuario, redirectUrl) {
    let usuarioLogado = null;
    switch (tipoUsuario) {
      case "admin":
        usuarioLogado = localStorage.getItem("adminLogado");
        break;
      case "paciente":
        usuarioLogado = localStorage.getItem("pacienteLogado");
        break;
      case "medico":
        usuarioLogado = localStorage.getItem("medicoLogado");
        break;
    }
    if (!usuarioLogado) {
      alert("Acesso negado! Faça login como " + tipoUsuario + ".");
      window.location.href = redirectUrl;
    }
  }
  verificarSessao("admin", "index.html");
});
</script>

<!-- HEADER -->
<header class="bg-success text-white py-3 d-flex justify-content-between align-items-center px-4">
  <div class="fs-4 fw-bold">Administração G.L.I.N.P</div>
  <button class="btn btn-light btn-sm" onclick="window.location.href='index.html'">Sair</button>
</header>

<!-- MAIN -->
<main class="container my-5">
  <div class="d-flex gap-3 justify-content-center mb-5 flex-wrap">
    <button onclick="window.location.href='cadastro-medico.html'" class="btn btn-outline-danger btn-lg px-4">
      Cadastro Médico
    </button>
    <button onclick="window.location.href='cadastro.html'" class="btn btn-outline-danger btn-lg px-4">
      Cadastro Paciente
    </button>
  </div>

  <hr class="my-4" />

  <h3 class="text-success mb-4 text-center">Pesquisar Agendamentos</h3>

  <form id="formPesquisa" class="row g-3 justify-content-center align-items-end">
    <div class="col-12 col-md-5">
      <label for="cpfCrm" class="form-label">CPF (Paciente) ou CRM (Médico)</label>
      <input type="text" id="cpfCrm" class="form-control" placeholder="Digite o CPF ou CRM" required />
    </div>
    <div class="col-12 col-md-4">
      <label for="dataConsulta" class="form-label">Data (opcional)</label>
      <input type="date" id="dataConsulta" class="form-control" />
    </div>
    <div class="col-12 col-md-2 d-grid">
      <button type="submit" class="btn btn-success btn-lg w-100">Pesquisar</button>
    </div>
  </form>

  <div id="resultadoPesquisa" class="mt-5"></div>
</main>

<!-- FOOTER -->
<footer class="footer-bg text-white py-3 text-center mt-auto bg-success">
  <div class="container">
    <p class="mb-0">Centro Paula Souza / ETEC Antonio Furlan / TCC - 2025</p>
  </div>
</footer>

<!-- Modal Resultados -->
<div class="modal fade" id="resultadoModal" tabindex="-1" aria-labelledby="resultadoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="resultadoModalLabel">Resultados da Pesquisa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body" id="modalBodyContent"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const formPesquisa = document.getElementById('formPesquisa');
  const modalBodyContent = document.getElementById('modalBodyContent');
  const resultadoModal = new bootstrap.Modal(document.getElementById('resultadoModal'));

  formPesquisa.addEventListener('submit', async (event) => {
    event.preventDefault();

    let valorInput = document.getElementById('cpfCrm').value.trim();
    const dataConsulta = document.getElementById('dataConsulta').value;

    if (!valorInput) {
      modalBodyContent.innerHTML = '<p class="text-danger">Por favor, insira CPF ou CRM.</p>';
      resultadoModal.show();
      return;
    }

    // Remove formatação e espaços
    const valorLimpo = valorInput.replace(/\D/g, '');

    // Monta URL de requisição
    const url = new URL('/admin/consultas', window.location.origin);
    if (valorLimpo.length === 11) {
      url.searchParams.append('cpf', valorLimpo); // CPF
    } else {
      url.searchParams.append('crm', valorLimpo); // CRM
    }
    if (dataConsulta) url.searchParams.append('data', dataConsulta);

    try {
      const res = await fetch(url, { method: 'GET', credentials: 'include' });
      const data = await res.json();

      if (!data.success) {
        modalBodyContent.innerHTML = `<p class="text-danger">${data.message}</p>`;
        resultadoModal.show();
        return;
      }

      const consultas = data.consultas;
      if (consultas.length === 0) {
        modalBodyContent.innerHTML = '<p class="text-warning">Nenhuma consulta encontrada.</p>';
        resultadoModal.show();
        return;
      }

      // Monta HTML dos resultados
      let resultadoHtml = `<p><strong>Pesquisa:</strong> ${valorInput}</p>`;
      if (dataConsulta) resultadoHtml += `<p><strong>Data selecionada:</strong> ${dataConsulta}</p>`;
      resultadoHtml += '<div class="list-group mt-3">';
      consultas.forEach(c => {
        const dataHora = new Date(c.data_horario).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
        resultadoHtml += `
          <div class="list-group-item mb-2 p-2 border rounded">
            <p><strong>Paciente:</strong> ${c.paciente_nome} (CPF: ${c.paciente_cpf})</p>
            <p><strong>Médico:</strong> ${c.medico_nome} (CRM: ${c.medico_crm}) - ${c.especialidade}</p>
            <p><strong>Data/Horário:</strong> ${dataHora}</p>
            <p><strong>Status:</strong> ${c.status}</p>
          </div>
        `;
      });
      resultadoHtml += '</div>';

      modalBodyContent.innerHTML = resultadoHtml;
      resultadoModal.show();

    } catch (err) {
      console.error('Erro ao buscar consultas:', err);
      modalBodyContent.innerHTML = '<p class="text-danger">Erro ao buscar consultas. Verifique o servidor.</p>';
      resultadoModal.show();
    }
  });
});
</script>

</body>
</html>
